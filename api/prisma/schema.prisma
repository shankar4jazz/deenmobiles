generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                  String                     @id @default(uuid())
  name                String
  email               String                     @unique
  phone               String
  address             String
  logo                String?
  gstin               String?                    // Company GSTIN for GST reporting
  stateCode           String?                    // 2-digit state code for place of supply
  jobSheetInstructions String?                   @db.Text  // Job sheet instructions (supports any language)
  isActive            Boolean                    @default(true)
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  branches            Branch[]
  customers           Customer[]
  inventories         Inventory[]
  invoices            Invoice[]
  jobSheets           JobSheet[]
  parts               Part[]
  roles               Role[]
  services            Service[]
  stockMovements      StockMovement[]
  suppliers           Supplier[]
  users               User[]
  purchaseOrders      PurchaseOrder[]
  supplierPayments    SupplierPayment[]
  itemCategories      ItemCategory[]
  itemUnits           ItemUnit[]
  itemGSTRates        ItemGSTRate[]
  itemBrands          ItemBrand[]
  itemModels          ItemModel[]
  faults              Fault[]
  deviceConditions    DeviceCondition[]
  customerDevices     CustomerDevice[]
  items               Item[]
  branchInventories   BranchInventory[]
  paymentMethods      PaymentMethod[]
  expenseCategories   ExpenseCategory[]
  pettyCashTransfers  PettyCashTransfer[]
  pettyCashRequests   PettyCashRequest[]
  expenses            Expense[]
  purchaseItemReturns PurchaseItemReturn[]
  refundTransactions  RefundTransaction[]
  performanceLogs     TechnicianPerformanceLog[]
  paymentEntries              PaymentEntry[]                 @relation("CompanyPaymentEntries")
  invoiceTemplates            InvoiceTemplate[]
  themes                      Theme[]
  jobSheetTemplates           JobSheetTemplate[]             @relation("CompanyJobSheetTemplates")
  jobSheetTemplateCategories  JobSheetTemplateCategory[]     @relation("CompanyJobSheetTemplateCategories")
  damageConditions            DamageCondition[]
  technicianLevels            TechnicianLevel[]
  technicianProfiles          TechnicianProfile[]
  documentNumberFormats       DocumentNumberFormat[]
  dailyOpeningBalances        DailyOpeningBalance[]
  tasks                       Task[]
  cashSettlements             CashSettlement[]
  warrantyRecords             WarrantyRecord[]
  salesReturns                SalesReturn[]

  @@map("companies")
}

model Branch {
  id                  String                     @id @default(uuid())
  name                String
  companyId           String
  address             String
  phone               String
  email               String
  gstin               String?                    // Branch GSTIN (if different from company)
  stateCode           String?                    // 2-digit state code for place of supply
  isActive            Boolean                    @default(true)
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  code                String                     @unique
  managerId           String?
  company             Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager             User?                      @relation("BranchManager", fields: [managerId], references: [id])
  customers           Customer[]
  customerDevices     CustomerDevice[]
  inventories         Inventory[]
  services            Service[]
  jobSheets           JobSheet[]
  stockMovements      StockMovement[]
  suppliers           Supplier[]
  users               User[]                     @relation("BranchUsers")
  purchaseOrders      PurchaseOrder[]
  supplierPayments    SupplierPayment[]
  branchInventories   BranchInventory[]
  pettyCashTransfers  PettyCashTransfer[]
  pettyCashRequests   PettyCashRequest[]
  expenses            Expense[]
  purchaseItemReturns PurchaseItemReturn[]
  refundTransactions  RefundTransaction[]
  performanceLogs     TechnicianPerformanceLog[]
  invoiceTemplates    InvoiceTemplate[]
  themes              Theme[]
  jobSheetTemplates   JobSheetTemplate[]         @relation("BranchJobSheetTemplates")
  technicianProfiles  TechnicianProfile[]
  documentSequences   DocumentSequence[]
  dailyOpeningBalances DailyOpeningBalance[]
  tasks               Task[]
  cashSettlements     CashSettlement[]
  warrantyRecords     WarrantyRecord[]
  salesReturns        SalesReturn[]

  @@index([companyId])
  @@index([managerId])
  @@index([code])
  @@map("branches")
}

model User {
  id                         String                     @id @default(uuid())
  email                      String?                    @unique
  password                   String
  name                       String
  phone                      String?
  role                       UserRole
  companyId                  String
  branchId                   String?
  isActive                   Boolean                    @default(true)
  lastLoginAt                DateTime?
  createdAt                  DateTime                   @default(now())
  updatedAt                  DateTime                   @updatedAt
  accountLockedUntil         DateTime?
  failedLoginAttempts        Int                        @default(0)
  lastFailedLoginAt          DateTime?
  customRoleId               String?
  username                   String?                    @unique
  roleId                     String?
  profileImage               String?
  activityLogs               ActivityLog[]
  managedBranches            Branch[]                   @relation("BranchManager")
  notifications              Notification[]
  refreshTokens              RefreshToken[]
  assignedServices           Service[]                  @relation("ServiceAssignedTo")
  createdServices            Service[]                  @relation("ServiceCreatedBy")
  stockMovements             StockMovement[]
  createdPurchaseOrders      PurchaseOrder[]            @relation("UserCreatedPurchaseOrders")
  createdSupplierPayments    SupplierPayment[]          @relation("UserCreatedPayments")
  branch                     Branch?                    @relation("BranchUsers", fields: [branchId], references: [id])
  company                    Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customRole                 Role?                      @relation(fields: [customRoleId], references: [id])
  assignedRole               Role?                      @relation("UserAssignedRole", fields: [roleId], references: [id])
  createdPettyCashTransfers  PettyCashTransfer[]        @relation("UserCreatedPettyCashTransfers")
  receivedPettyCashTransfers PettyCashTransfer[]        @relation("EmployeeReceivedPettyCashTransfers")
  requestedPettyCash         PettyCashRequest[]         @relation("UserRequestedPettyCash")
  approvedPettyCashRequests  PettyCashRequest[]         @relation("UserApprovedPettyCash")
  recordedExpenses           Expense[]                  @relation("UserRecordedExpenses")
  createdPurchaseReturns     PurchaseItemReturn[]       @relation("UserCreatedPurchaseReturns")
  processedRefunds           RefundTransaction[]        @relation("UserProcessedRefunds")
  performanceLogs            TechnicianPerformanceLog[] @relation("TechnicianPerformance")
  generatedJobSheets         JobSheet[]                 @relation("UserGeneratedJobSheets")
  statusChanges              ServiceStatusHistory[]     @relation("UserStatusChanges")
  createdInvoiceTemplates    InvoiceTemplate[]          @relation("UserCreatedInvoiceTemplates")
  createdThemes              Theme[]                    @relation("UserCreatedThemes")
  createdJobSheetTemplates   JobSheetTemplate[]         @relation("UserCreatedJobSheetTemplates")
  technicianProfile          TechnicianProfile?
  technicianNotifications    TechnicianNotification[]
  serviceNotes               ServiceNote[]              @relation("ServiceNotesByUser")
  deviceReturns              Service[]                  @relation("DeviceReturnedBy")
  serviceRefundsProcessed    Service[]                  @relation("ServiceRefundsBy")
  createdSalesReturns        SalesReturn[]              @relation("UserCreatedSalesReturns")
  processedSalesReturns      SalesReturn[]              @relation("UserProcessedSalesReturns")
  approvedParts              ServicePart[]              @relation("UserPartApprovals")
  tasksAssigned              Task[]                     @relation("TaskAssignee")
  tasksCreated               Task[]                     @relation("TaskCreator")
  settlementsSettled         CashSettlement[]           @relation("SettlementSettledBy")
  settlementsVerified        CashSettlement[]           @relation("SettlementVerifiedBy")
  settlementsRejected        CashSettlement[]           @relation("SettlementRejectedBy")

  @@index([companyId])
  @@index([branchId])
  @@index([customRoleId])
  @@index([roleId])
  @@index([email])
  @@index([username])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Role {
  id            String           @id @default(uuid())
  name          String
  description   String?
  isSystemRole  Boolean          @default(false)
  companyId     String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  permissions   RolePermission[]
  company       Company?         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users         User[]
  assignedUsers User[]           @relation("UserAssignedRole")

  @@unique([name, companyId])
  @@index([companyId])
  @@index([isSystemRole])
  @@map("roles")
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  resource    String
  action      String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       RolePermission[]

  @@index([resource])
  @@index([action])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model Customer {
  id              String           @id @default(uuid())
  name            String
  email           String?
  phone           String
  address         String?
  gstin           String?          // GSTIN for B2B customers (15 chars)
  stateCode       String?          // 2-digit state code for place of supply
  companyId       String
  branchId        String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  idProofDocument String?
  idProofType     String?
  remarks         String?
  whatsappNumber  String?
  alternativeMobile String?
  branch          Branch?          @relation(fields: [branchId], references: [id])
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  services        Service[]
  devices         CustomerDevice[]
  invoices        Invoice[]        @relation("InvoiceCustomer")
  estimates       Estimate[]       @relation("EstimateCustomer")
  warrantyRecords WarrantyRecord[]
  salesReturns    SalesReturn[]    @relation("SalesReturnCustomer")

  @@unique([phone, companyId])
  @@index([companyId])
  @@index([branchId])
  @@index([phone])
  @@map("customers")
}

model Service {
  id                String                 @id @default(uuid())
  ticketNumber      String                 @unique
  customerId        String
  customerDeviceId  String?
  deviceModel       String
  deviceIMEI        String?
  devicePassword    String?
  devicePattern     String?                // Pattern lock (stored as "1,2,3,5,9" format)
  deviceCondition   String?                // Device power state at intake: "on" or "off"
  intakeNotes       String?                // Notes about device condition at intake
  damageCondition   String                 @map("issue") // Damage condition description (e.g., "Screen Damage, Back Door Damage")
  diagnosis         String?
  estimatedCost     Float
  actualCost        Float?
  labourCharge      Float                  @default(0)
  advancePayment    Float                  @default(0)
  extraSpareAmount  Float                  @default(0)  // Extra parts cost beyond estimate
  discount          Float                  @default(0)  // Discount amount
  status            ServiceStatus          @default(PENDING)
  deliveryStatus    DeliveryStatus?        // Set when service reaches READY/NOT_READY
  assignedToId      String?
  createdById       String?                // User who created/booked the service
  dataWarrantyAccepted Boolean             @default(false) // Customer accepts data loss risk
  sendNotificationOnAssign Boolean         @default(true)  // @deprecated - use sendSmsNotification instead
  sendSmsNotification Boolean              @default(true)  // Send SMS notification to customer
  sendWhatsappNotification Boolean         @default(false) // Send WhatsApp notification to customer
  companyId         String
  branchId          String
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  completedAt       DateTime?
  deliveredAt       DateTime?
  notServiceableReason String?              // Reason why device cannot be serviced
  deviceReturnedAt  DateTime?              // When device was physically returned to customer
  deviceReturnedById String?               // User who returned device to customer
  // Refund fields
  refundAmount          Float?
  refundReason          String?             @db.Text
  refundPaymentMethodId String?
  refundedAt            DateTime?
  refundedById          String?
  // Repeated service tracking
  isRepeatedService Boolean                @default(false) // True if device was serviced within 30 days
  previousServiceId String?                // Link to the previous service
  previousService   Service?               @relation("RepeatedService", fields: [previousServiceId], references: [id], onDelete: SetNull)
  repeatedServices  Service[]              @relation("RepeatedService")
  // Warranty repair fields
  isWarrantyRepair  Boolean                @default(false) // True if marked as warranty/free repair
  warrantyReason    String?                // e.g., "SAME_FAULT", "STAFF_OVERRIDE"
  matchingFaultIds  String[]               // IDs of faults that matched previous service
  invoice           Invoice?
  jobSheet          JobSheet?
  estimate          Estimate? // Formal estimate linked to service
  notifications     Notification[]
  images            ServiceImage[]
  deviceImages      DeviceImage[]
  partsUsed         ServicePart[]
  statusHistory     ServiceStatusHistory[]
  rating            ServiceRating?
  assignedTo        User?                  @relation("ServiceAssignedTo", fields: [assignedToId], references: [id])
  createdBy         User?                  @relation("ServiceCreatedBy", fields: [createdById], references: [id])
  deviceReturnedBy  User?                  @relation("DeviceReturnedBy", fields: [deviceReturnedById], references: [id])
  refundPaymentMethod PaymentMethod?       @relation("ServiceRefunds", fields: [refundPaymentMethodId], references: [id])
  refundedBy        User?                  @relation("ServiceRefundsBy", fields: [refundedById], references: [id])
  branch            Branch                 @relation(fields: [branchId], references: [id], onDelete: Cascade)
  company           Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer          Customer               @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerDevice    CustomerDevice?        @relation(fields: [customerDeviceId], references: [id], onDelete: SetNull)
  paymentEntries    PaymentEntry[]         @relation("ServicePaymentEntries")
  damageConditions  DamageConditionOnService[]
  accessories       ServiceAccessory[]
  pointsHistory     TechnicianPointsHistory[]
  notes             ServiceNote[]
  faults            FaultOnService[]
  warrantyRecords   WarrantyRecord[]   @relation("ServiceWarrantyRecords")
  warrantyClaimFor  WarrantyRecord[]   @relation("WarrantyClaimService")

  @@index([companyId])
  @@index([branchId])
  @@index([customerId])
  @@index([assignedToId])
  @@index([ticketNumber])
  @@index([status])
  @@index([createdById])
  @@index([previousServiceId])
  @@index([customerDeviceId, createdAt]) // For repeated service lookups
  @@map("services")
}

model ServiceNote {
  id        String   @id @default(uuid())
  serviceId String
  note      String   @db.Text
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  user      User     @relation("ServiceNotesByUser", fields: [createdBy], references: [id])

  @@index([serviceId])
  @@index([createdBy])
  @@map("service_notes")
}

model Part {
  id           String        @id @default(uuid())
  name         String
  partNumber   String?
  description  String?
  costPrice    Float
  sellingPrice Float
  quantity     Int
  minQuantity  Int           @default(5)
  companyId    String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  servicesUsed ServicePart[]

  @@index([companyId])
  @@index([partNumber])
  @@map("parts")
}

model ServicePart {
  id                String           @id @default(uuid())
  serviceId         String
  partId            String?          // Legacy - kept for backward compatibility
  branchInventoryId String?          // New: reference to branch inventory
  itemId            String?          // New: reference to item
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  createdAt         DateTime         @default(now())

  // Part classification
  isExtraSpare      Boolean          @default(false)  // true = extra spare, false = tagged part
  faultTag          String?          // Which fault tag this part belongs to (e.g., "mic", "speaker")

  // Customer approval fields (only for extra spare parts)
  isApproved        Boolean          @default(false)
  approvalMethod    String?          // PHONE_CALL, WHATSAPP, IN_PERSON, SMS, WARRANTY_INTERNAL
  approvalNote      String?
  approvedAt        DateTime?
  approvedById      String?

  part              Part?            @relation(fields: [partId], references: [id], onDelete: Cascade)
  branchInventory   BranchInventory? @relation(fields: [branchInventoryId], references: [id], onDelete: SetNull)
  item              Item?            @relation(fields: [itemId], references: [id], onDelete: SetNull)
  service           Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  approvedBy        User?            @relation("UserPartApprovals", fields: [approvedById], references: [id], onDelete: SetNull)
  warrantyRecord    WarrantyRecord?

  @@index([serviceId])
  @@index([partId])
  @@index([branchInventoryId])
  @@index([itemId])
  @@index([approvedById])
  @@map("service_parts")
}

model ServiceImage {
  id        String   @id @default(uuid())
  serviceId String
  imageUrl  String
  caption   String?
  createdAt DateTime @default(now())
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@map("service_images")
}

model DeviceImage {
  id        String   @id @default(uuid())
  serviceId String
  imageUrl  String
  caption   String?
  createdAt DateTime @default(now())
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@map("device_images")
}

model ServiceStatusHistory {
  id            String        @id @default(uuid())
  serviceId     String
  status        ServiceStatus
  notes         String?
  changedBy     String?
  createdAt     DateTime      @default(now())
  service       Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  changedByUser User?         @relation("UserStatusChanges", fields: [changedBy], references: [id], onDelete: SetNull)

  @@index([serviceId])
  @@index([changedBy])
  @@map("service_status_history")
}

model Invoice {
  id               String        @id @default(uuid())
  invoiceNumber    String        @unique
  serviceId        String?       @unique // Made optional for standalone invoices
  customerId       String? // For standalone invoices without service
  estimateId       String?       @unique // Link to estimate if converted
  totalAmount      Float
  paidAmount       Float         @default(0)
  balanceAmount    Float
  paymentStatus    PaymentStatus @default(PENDING)
  isWarrantyInvoice Boolean      @default(false) // True if warranty repair invoice
  // GST fields for GSTR1 reporting
  taxableValue     Float?        // Total taxable value (before tax)
  cgstTotal        Float?        // Total CGST amount
  sgstTotal        Float?        // Total SGST amount
  igstTotal        Float?        // Total IGST amount
  cessTotal        Float?        // Total Cess amount
  placeOfSupply    String?       // 2-digit state code
  reverseCharge    Boolean       @default(false) // Reverse charge applicability
  companyId        String
  branchId         String? // For standalone invoices
  themeId          String? // PDF theme
  pdfUrl           String?
  notes            String?       @db.Text
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  service       Service?      @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  customer      Customer?     @relation("InvoiceCustomer", fields: [customerId], references: [id], onDelete: SetNull)
  estimate      Estimate?     @relation("EstimateConvertedInvoice", fields: [estimateId], references: [id], onDelete: SetNull)
  theme         Theme?        @relation("InvoiceTheme", fields: [themeId], references: [id], onDelete: SetNull)
  payments      Payment[]
  items         InvoiceItem[] // Line items for standalone invoices
  warrantyRecords WarrantyRecord[]
  salesReturns  SalesReturn[]

  @@index([companyId])
  @@index([serviceId])
  @@index([customerId])
  @@index([estimateId])
  @@index([themeId])
  @@index([invoiceNumber])
  @@map("invoices")
}

model InvoiceItem {
  id           String   @id @default(uuid())
  invoiceId    String
  itemId       String?  // Optional - links to Item catalog for warranty tracking
  description  String
  quantity     Float
  unitPrice    Float
  amount       Float
  // GST fields for GSTR1 reporting
  hsnCode      String?  // HSN/SAC code
  taxableValue Float?   // Base amount before tax
  gstRate      Float?   // GST percentage (0, 5, 12, 18, 28)
  cgstRate     Float?   // CGST rate (half of GST for intra-state)
  sgstRate     Float?   // SGST rate (half of GST for intra-state)
  igstRate     Float?   // IGST rate (full GST for inter-state)
  cgstAmount   Float?   // CGST amount
  sgstAmount   Float?   // SGST amount
  igstAmount   Float?   // IGST amount
  cessAmount   Float?   // Cess amount (if applicable)
  createdAt    DateTime @default(now())
  invoice      Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  item         Item?    @relation(fields: [itemId], references: [id], onDelete: SetNull)
  salesReturnItems SalesReturnItem[]

  @@index([invoiceId])
  @@index([hsnCode])
  @@index([itemId])
  @@map("invoice_items")
}

model InvoiceTemplate {
  id          String                  @id @default(uuid())
  name        String
  description String?                 @db.Text
  notes       String?                 @db.Text
  taxRate     Float                   @default(18)
  isActive    Boolean                 @default(true)
  companyId   String
  branchId    String?
  createdBy   String
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  company     Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch      Branch?                 @relation(fields: [branchId], references: [id], onDelete: Cascade)
  createdByUser User                  @relation("UserCreatedInvoiceTemplates", fields: [createdBy], references: [id])
  items       InvoiceTemplateItem[]

  @@index([companyId])
  @@index([branchId])
  @@map("invoice_templates")
}

model InvoiceTemplateItem {
  id          String          @id @default(uuid())
  templateId  String
  description String
  quantity    Float           @default(1)
  unitPrice   Float
  sortOrder   Int             @default(0)
  createdAt   DateTime        @default(now())
  template    InvoiceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("invoice_template_items")
}

model Theme {
  id                      String   @id @default(uuid())
  name                    String
  description             String?  @db.Text
  primaryColor            String   @default("#7C3AED") // Purple
  secondaryColor          String   @default("#6366F1") // Indigo
  headerBackgroundColor   String   @default("#7C3AED")
  headerTextColor         String   @default("#FFFFFF")
  fontFamily              String   @default("Helvetica")
  fontSize                Float    @default(10)
  logoUrl                 String?
  showBranchInfo          Boolean  @default(true)
  showTermsAndConditions  Boolean  @default(true)
  termsAndConditions      String?  @db.Text
  footerText              String?
  isDefault               Boolean  @default(false)
  isActive                Boolean  @default(true)
  companyId               String
  branchId                String?
  createdBy               String
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  company       Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch        Branch?    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  createdByUser User       @relation("UserCreatedThemes", fields: [createdBy], references: [id])
  invoices      Invoice[]  @relation("InvoiceTheme")
  estimates     Estimate[] @relation("EstimateTheme")

  @@index([companyId])
  @@index([branchId])
  @@index([isDefault])
  @@index([isActive])
  @@map("themes")
}

model JobSheet {
  id                     String            @id @default(uuid())
  jobSheetNumber         String            @unique
  serviceId              String            @unique
  generatedAt            DateTime          @default(now())
  generatedBy            String
  pdfUrl                 String?
  templateId             String?
  customerSignatureUrl   String?
  authorizedSignatureUrl String?
  companyId              String
  branchId               String
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  service                Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  generatedByUser        User              @relation("UserGeneratedJobSheets", fields: [generatedBy], references: [id])
  company                Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch                 Branch            @relation(fields: [branchId], references: [id], onDelete: Cascade)
  template               JobSheetTemplate? @relation("JobSheetTemplate", fields: [templateId], references: [id], onDelete: SetNull)

  @@index([serviceId])
  @@index([generatedBy])
  @@index([companyId])
  @@index([branchId])
  @@index([jobSheetNumber])
  @@index([templateId])
  @@map("job_sheets")
}

model JobSheetTemplateCategory {
  id          String             @id @default(uuid())
  name        String
  description String?
  isActive    Boolean            @default(true)
  companyId   String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  company     Company            @relation("CompanyJobSheetTemplateCategories", fields: [companyId], references: [id], onDelete: Cascade)
  templates   JobSheetTemplate[]

  @@unique([name, companyId])
  @@index([companyId])
  @@index([isActive])
  @@map("job_sheet_template_categories")
}

model JobSheetTemplate {
  id                      String                    @id @default(uuid())
  name                    String
  description             String?                   @db.Text
  categoryId              String?
  termsAndConditions      String?                   @db.Text
  showCustomerSignature   Boolean                   @default(true)
  showAuthorizedSignature Boolean                   @default(true)
  showCompanyLogo         Boolean                   @default(true)
  showContactDetails      Boolean                   @default(true)
  footerText              String?
  isDefault               Boolean                   @default(false)
  isActive                Boolean                   @default(true)
  companyId               String
  branchId                String?
  createdBy               String
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  company                 Company                   @relation("CompanyJobSheetTemplates", fields: [companyId], references: [id], onDelete: Cascade)
  branch                  Branch?                   @relation("BranchJobSheetTemplates", fields: [branchId], references: [id], onDelete: Cascade)
  createdByUser           User                      @relation("UserCreatedJobSheetTemplates", fields: [createdBy], references: [id])
  category                JobSheetTemplateCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  jobSheets               JobSheet[]                @relation("JobSheetTemplate")

  @@index([companyId])
  @@index([branchId])
  @@index([categoryId])
  @@index([isDefault])
  @@index([isActive])
  @@index([createdBy])
  @@map("job_sheet_templates")
}

model Estimate {
  id              String         @id @default(uuid())
  estimateNumber  String         @unique
  customerId      String
  serviceId       String?        @unique // Optional link to service
  status          EstimateStatus @default(DRAFT)
  subtotal        Float
  taxAmount       Float          @default(0)
  totalAmount     Float
  validUntil      DateTime?
  notes           String?        @db.Text
  pdfUrl          String?
  companyId       String
  branchId        String
  themeId         String? // PDF theme
  createdBy       String? // User who created estimate
  sentAt          DateTime? // When estimate was sent to customer
  approvedAt      DateTime? // When customer approved
  convertedAt     DateTime? // When converted to invoice
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  customer        Customer       @relation("EstimateCustomer", fields: [customerId], references: [id], onDelete: Cascade)
  service         Service?       @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  theme           Theme?         @relation("EstimateTheme", fields: [themeId], references: [id], onDelete: SetNull)
  items           EstimateItem[]
  convertedInvoice Invoice?      @relation("EstimateConvertedInvoice")

  @@index([companyId])
  @@index([branchId])
  @@index([customerId])
  @@index([serviceId])
  @@index([themeId])
  @@index([estimateNumber])
  @@index([status])
  @@map("estimates")
}

model EstimateItem {
  id          String   @id @default(uuid())
  estimateId  String
  description String
  quantity    Float
  unitPrice   Float
  amount      Float
  createdAt   DateTime @default(now())
  estimate    Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  @@index([estimateId])
  @@map("estimate_items")
}

model Payment {
  id              String         @id @default(uuid())
  invoiceId       String
  amount          Float
  paymentMethodId String?
  notes           String?
  transactionId   String?
  createdAt       DateTime       @default(now())
  invoice         Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  paymentMethod   PaymentMethod? @relation("PaymentMethodInvoicePayments", fields: [paymentMethodId], references: [id])

  @@index([invoiceId])
  @@index([paymentMethodId])
  @@map("payments")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  serviceId String?
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([serviceId])
  @@index([isRead])
  @@map("notifications")
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entity, entityId])
  @@map("activity_logs")
}

model Supplier {
  id                String            @id @default(uuid())
  supplierCode      String            @unique
  name              String
  contactPerson     String?
  email             String?
  phone             String
  alternatePhone    String?
  address           String?
  city              String?
  state             String?
  pincode           String?
  gstNumber         String?
  panNumber         String?
  bankName          String?
  accountNumber     String?
  ifscCode          String?
  active            Boolean           @default(true)
  companyId         String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  branchId          String?
  inventories       Inventory[]
  purchaseOrders    PurchaseOrder[]
  supplierPayments  SupplierPayment[]
  branch            Branch?           @relation(fields: [branchId], references: [id], onDelete: Cascade)
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branchInventories BranchInventory[]

  @@index([companyId])
  @@index([branchId])
  @@index([supplierCode])
  @@index([active])
  @@map("suppliers")
}

model ItemCategory {
  id          String      @id @default(uuid())
  name        String
  code        String?
  description String?
  isActive    Boolean     @default(true)
  companyId   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inventories Inventory[] @relation("InventoryItemCategory")
  items       Item[]      @relation("ItemCategoryItems")

  @@unique([name, companyId])
  @@index([companyId])
  @@index([isActive])
  @@map("item_categories")
}

model ItemUnit {
  id          String      @id @default(uuid())
  name        String
  code        String      @unique
  symbol      String?
  description String?
  isActive    Boolean     @default(true)
  companyId   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inventories Inventory[] @relation("InventoryItemUnit")
  items       Item[]      @relation("ItemUnitItems")

  @@index([companyId])
  @@index([code])
  @@index([isActive])
  @@map("item_units")
}

model ItemGSTRate {
  id          String      @id @default(uuid())
  name        String
  rate        Decimal     @db.Decimal(5, 2)
  description String?
  isActive    Boolean     @default(true)
  companyId   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inventories Inventory[] @relation("InventoryItemGSTRate")
  items       Item[]      @relation("ItemGSTRateItems")

  @@index([companyId])
  @@index([rate])
  @@index([isActive])
  @@map("item_gst_rates")
}

model PaymentMethod {
  id                 String              @id @default(uuid())
  name               String
  code               String              @unique
  description        String?
  isActive           Boolean             @default(true)
  companyId          String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplierPayments   SupplierPayment[]   @relation("PaymentMethodSupplierPayments")
  invoicePayments    Payment[]           @relation("PaymentMethodInvoicePayments")
  pettyCashTransfers PettyCashTransfer[]
  refundTransactions RefundTransaction[] @relation("RefundPaymentMethod")
  paymentEntries     PaymentEntry[]      @relation("PaymentEntries")
  serviceRefunds     Service[]           @relation("ServiceRefunds")
  salesReturnRefunds SalesReturn[]       @relation("SalesReturnRefunds")
  openingBalances    DailyOpeningBalance[] @relation("PaymentMethodOpeningBalances")
  settlementMethods  CashSettlementMethod[] @relation("SettlementMethods")

  @@index([companyId])
  @@index([code])
  @@index([isActive])
  @@map("payment_methods")
}

model PaymentEntry {
  id              String        @id @default(uuid())
  amount          Float
  paymentMethodId String
  paymentMethod   PaymentMethod @relation("PaymentEntries", fields: [paymentMethodId], references: [id])
  notes           String?
  transactionId   String?
  paymentDate     DateTime      @default(now())

  // Polymorphic relations (one of these will be set)
  serviceId String?
  service   Service? @relation("ServicePaymentEntries", fields: [serviceId], references: [id], onDelete: Cascade)

  expenseId String?
  expense   Expense? @relation("ExpensePaymentEntries", fields: [expenseId], references: [id], onDelete: Cascade)

  companyId String
  company   Company  @relation("CompanyPaymentEntries", fields: [companyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceId])
  @@index([expenseId])
  @@index([paymentMethodId])
  @@index([companyId])
  @@index([paymentDate])
  @@map("payment_entries")
}

model ItemBrand {
  id              String           @id @default(uuid())
  name            String
  code            String?
  description     String?
  isActive        Boolean          @default(true)
  companyId       String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inventories     Inventory[]      @relation("InventoryItemBrand")
  models          ItemModel[]
  items           Item[]           @relation("ItemBrandItems")
  customerDevices CustomerDevice[]

  @@unique([name, companyId])
  @@index([companyId])
  @@index([isActive])
  @@map("item_brands")
}

model ItemModel {
  id              String           @id @default(uuid())
  name            String
  code            String?
  description     String?
  brandId         String?
  isActive        Boolean          @default(true)
  companyId       String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  brand           ItemBrand?       @relation(fields: [brandId], references: [id], onDelete: SetNull)
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inventories     Inventory[]      @relation("InventoryItemModel")
  items           Item[]           @relation("ItemModelItems")
  customerDevices CustomerDevice[]

  @@unique([name, brandId, companyId])
  @@index([companyId])
  @@index([brandId])
  @@index([isActive])
  @@map("item_models")
}

model Fault {
  id               String           @id @default(uuid())
  name             String
  code             String?
  description      String?
  tags             String?          // Comma-separated part tags: "mic,speaker,board"
  defaultPrice     Decimal          @default(0) @db.Decimal(10, 2)
  level            Int              @default(1) // 1=Easy, 5=Hard
  technicianPoints Int              @default(0)
  isActive         Boolean          @default(true)
  companyId        String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  company          Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  services         FaultOnService[]
  technicianSkills TechnicianSkill[]

  @@unique([name, companyId])
  @@index([companyId])
  @@index([isActive])
  @@index([level])
  @@map("faults")
}

// Junction table for Service and Fault (many-to-many)
model FaultOnService {
  id        String   @id @default(uuid())
  serviceId String
  faultId   String
  createdAt DateTime @default(now())
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  fault     Fault    @relation(fields: [faultId], references: [id], onDelete: Cascade)

  @@unique([serviceId, faultId])
  @@index([serviceId])
  @@index([faultId])
  @@map("fault_on_services")
}

model DamageCondition {
  id          String                     @id @default(uuid())
  name        String
  description String?
  isActive    Boolean                    @default(true)
  companyId   String
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  company     Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  services    DamageConditionOnService[]

  @@unique([name, companyId])
  @@index([companyId])
  @@index([isActive])
  @@map("damage_conditions")
}

// Accessory Master Data - Global accessories list
model Accessory {
  id          String             @id @default(uuid())
  name        String             @unique
  code        String?            @unique
  description String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  services    ServiceAccessory[]

  @@index([isActive])
  @@index([name])
  @@map("accessories")
}

// Junction table for Service and Accessory (many-to-many)
model ServiceAccessory {
  id          String    @id @default(uuid())
  serviceId   String
  accessoryId String
  createdAt   DateTime  @default(now())
  service     Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  accessory   Accessory @relation(fields: [accessoryId], references: [id], onDelete: Cascade)

  @@unique([serviceId, accessoryId])
  @@index([serviceId])
  @@index([accessoryId])
  @@map("service_accessories")
}

model DamageConditionOnService {
  id                String          @id @default(uuid())
  serviceId         String
  damageConditionId String
  createdAt         DateTime        @default(now())
  service           Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  damageCondition   DamageCondition @relation(fields: [damageConditionId], references: [id], onDelete: Cascade)

  @@unique([serviceId, damageConditionId])
  @@index([serviceId])
  @@index([damageConditionId])
  @@map("damage_condition_on_services")
}

model DeviceCondition {
  id              String           @id @default(uuid())
  name            String
  code            String?
  description     String?
  isActive        Boolean          @default(true)
  companyId       String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([name, companyId])
  @@index([companyId])
  @@index([isActive])
  @@map("device_conditions")
}

model CustomerDevice {
  id           String           @id @default(uuid())
  customerId   String
  brandId      String
  modelId      String
  imei         String?
  color        String?
  isActive     Boolean          @default(true)
  companyId    String
  branchId     String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  customer     Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  brand        ItemBrand        @relation(fields: [brandId], references: [id], onDelete: Restrict)
  model        ItemModel        @relation(fields: [modelId], references: [id], onDelete: Restrict)
  company      Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch       Branch?          @relation(fields: [branchId], references: [id], onDelete: SetNull)
  services     Service[]
  images       CustomerDeviceImage[]

  @@index([customerId])
  @@index([brandId])
  @@index([modelId])
  @@index([companyId])
  @@index([branchId])
  @@index([isActive])
  @@map("customer_devices")
}

// Customer Device Images - stores photos of customer devices
model CustomerDeviceImage {
  id               String         @id @default(uuid())
  customerDeviceId String
  imageUrl         String
  caption          String?
  createdAt        DateTime       @default(now())
  customerDevice   CustomerDevice @relation(fields: [customerDeviceId], references: [id], onDelete: Cascade)

  @@index([customerDeviceId])
  @@map("customer_device_images")
}

// Company-level item catalog
model Item {
  id            String   @id @default(uuid())
  itemCode      String   @unique
  barcode       String?  @unique
  itemName      String
  description   String?
  modelVariant  String?
  brandId       String?
  modelId       String?
  categoryId    String?
  unitId        String?
  purchasePrice Decimal? @db.Decimal(10, 2)
  salesPrice    Decimal? @db.Decimal(10, 2)
  hsnCode       String?
  gstRateId     String?
  taxType       TaxType?
  isActive      Boolean  @default(true)
  companyId     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Warranty fields
  warrantyDays  Int?     @default(0)    // 0 = No warranty, 30/90/180/365 = months, custom days
  warrantyType  String?  // "NONE", "1_MONTH", "3_MONTHS", "6_MONTHS", "1_YEAR", "CUSTOM"

  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  itemCategory       ItemCategory?       @relation("ItemCategoryItems", fields: [categoryId], references: [id])
  itemUnit           ItemUnit?           @relation("ItemUnitItems", fields: [unitId], references: [id])
  itemGSTRate        ItemGSTRate?        @relation("ItemGSTRateItems", fields: [gstRateId], references: [id])
  itemBrand          ItemBrand?          @relation("ItemBrandItems", fields: [brandId], references: [id])
  itemModel          ItemModel?          @relation("ItemModelItems", fields: [modelId], references: [id])
  branchInventories  BranchInventory[]
  purchaseOrderItems PurchaseOrderItem[]
  serviceParts       ServicePart[]       // Parts used in services
  invoiceItems       InvoiceItem[]       // Items used in invoices (for warranty tracking)
  warrantyRecords    WarrantyRecord[]

  @@index([companyId])
  @@index([itemCode])
  @@index([categoryId])
  @@index([brandId])
  @@index([modelId])
  @@index([isActive])
  @@index([itemName, companyId])
  @@map("items")
}

// Branch-level inventory/stock
model BranchInventory {
  id                String    @id @default(uuid())
  itemId            String
  branchId          String
  companyId         String
  stockQuantity     Decimal   @default(0) @db.Decimal(10, 2)
  minStockLevel     Decimal?  @db.Decimal(10, 2)
  maxStockLevel     Decimal?  @db.Decimal(10, 2)
  reorderLevel      Decimal?  @db.Decimal(10, 2)
  supplierId        String?
  lastPurchasePrice Decimal?  @db.Decimal(10, 2)
  lastPurchaseDate  DateTime?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  item           Item            @relation(fields: [itemId], references: [id], onDelete: Cascade)
  branch         Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier       Supplier?       @relation(fields: [supplierId], references: [id])
  stockMovements StockMovement[]
  serviceParts   ServicePart[]   // Parts used in services from this inventory

  @@unique([itemId, branchId])
  @@index([itemId])
  @@index([branchId, companyId])
  @@index([stockQuantity])
  @@index([isActive])
  @@map("branch_inventories")
}

model Inventory {
  id                    String              @id @default(uuid())
  partNumber            String              @unique
  partName              String
  description           String?
  modelVariant          String?
  brandName             String?
  brandId               String?
  modelId               String?
  category              InventoryCategory?
  categoryId            String?
  unit                  Unit
  unitId                String?
  purchasePrice         Decimal?            @db.Decimal(10, 2)
  salesPrice            Decimal?            @db.Decimal(10, 2)
  hsnCode               String
  gstRate               GSTRate
  gstRateId             String?
  taxType               TaxType
  stockQuantity         Decimal             @default(0) @db.Decimal(10, 2)
  minStockLevel         Decimal?            @db.Decimal(10, 2)
  maxStockLevel         Decimal?            @db.Decimal(10, 2)
  reorderLevel          Decimal?            @db.Decimal(10, 2)
  supplierId            String?
  supplierInvoiceNumber String?
  purchaseDate          DateTime?
  billAttachmentUrl     String?
  active                Boolean             @default(true)
  branchId              String
  companyId             String
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  branch                Branch              @relation(fields: [branchId], references: [id], onDelete: Cascade)
  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier              Supplier?           @relation(fields: [supplierId], references: [id])
  itemCategory          ItemCategory?       @relation("InventoryItemCategory", fields: [categoryId], references: [id])
  itemUnit              ItemUnit?           @relation("InventoryItemUnit", fields: [unitId], references: [id])
  itemGSTRate           ItemGSTRate?        @relation("InventoryItemGSTRate", fields: [gstRateId], references: [id])
  itemBrand             ItemBrand?          @relation("InventoryItemBrand", fields: [brandId], references: [id])
  itemModel             ItemModel?          @relation("InventoryItemModel", fields: [modelId], references: [id])
  stockMovements        StockMovement[]
  purchaseOrderItems    PurchaseOrderItem[]

  @@index([branchId, companyId, active])
  @@index([category, active])
  @@index([stockQuantity])
  @@index([partNumber])
  @@index([hsnCode])
  @@index([categoryId])
  @@index([unitId])
  @@index([gstRateId])
  @@map("inventories")
}

model StockMovement {
  id                String            @id @default(uuid())
  inventoryId       String? // Old inventory reference (deprecated, keep for migration)
  branchInventoryId String? // New branch inventory reference
  movementType      StockMovementType
  quantity          Decimal           @db.Decimal(10, 2)
  previousQty       Decimal           @db.Decimal(10, 2)
  newQty            Decimal           @db.Decimal(10, 2)
  referenceType     String?
  referenceId       String?
  notes             String?
  userId            String
  branchId          String
  companyId         String
  createdAt         DateTime          @default(now())
  branch            Branch            @relation(fields: [branchId], references: [id], onDelete: Cascade)
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inventory         Inventory?        @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  branchInventory   BranchInventory?  @relation(fields: [branchInventoryId], references: [id], onDelete: Cascade)
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@index([branchInventoryId])
  @@index([branchId, companyId])
  @@index([userId])
  @@index([createdAt])
  @@index([movementType])
  @@map("stock_movements")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  TECHNICIAN
  RECEPTIONIST
  BRANCH_ADMIN
  SERVICE_ADMIN
  SERVICE_MANAGER
  CUSTOMER_SUPPORT
}

enum ServiceStatus {
  PENDING
  IN_PROGRESS
  WAITING_PARTS
  READY
  NOT_READY
}

enum DeliveryStatus {
  PENDING
  DELIVERED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

enum EstimateStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  CONVERTED
  EXPIRED
}

enum InventoryCategory {
  ELECTRICAL
  MECHANICAL
  DISPLAY
  BATTERY
  ACCESSORY
  CHARGER
  CABLE
  CASE_COVER
  SCREEN_PROTECTOR
  AUDIO
  CAMERA
  OTHER
}

enum Unit {
  PIECE
  METER
  LITRE
  KILOGRAM
  BOX
  SET
  PAIR
  ROLL
  PACKET
}

enum GSTRate {
  ZERO
  FIVE
  TWELVE
  EIGHTEEN
  TWENTY_EIGHT
}

enum TaxType {
  IGST
  CGST_SGST
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  PARTIALLY_RECEIVED
  RECEIVED
  COMPLETED
  CANCELLED
}

enum StockMovementType {
  PURCHASE
  SALE
  ADJUSTMENT
  TRANSFER
  SERVICE_USE
  RETURN
  DAMAGE
  OPENING_STOCK
}

enum PettyCashTransferStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum PettyCashRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PurchaseReturnReason {
  DAMAGED
  WRONG_ITEM
  QUALITY_ISSUE
  EXCESS_STOCK
  EXPIRED
  OTHER
}

enum PurchaseReturnType {
  REFUND
  REPLACEMENT
}

enum PurchaseReturnStatus {
  PENDING
  CONFIRMED
  REJECTED
}

enum SalesReturnReason {
  DEFECTIVE
  WRONG_ITEM
  CUSTOMER_CHANGED_MIND
  DUPLICATE_BILLING
  PRICE_ADJUSTMENT
  OTHER
}

enum SalesReturnStatus {
  PENDING
  CONFIRMED
  REJECTED
}

enum CashSettlementStatus {
  PENDING
  SUBMITTED
  VERIFIED
  REJECTED
}

model PurchaseOrder {
  id               String              @id @default(uuid())
  poNumber         String              @unique
  supplierId       String
  branchId         String
  companyId        String
  orderDate        DateTime            @default(now())
  expectedDelivery DateTime?
  deliveryDate     DateTime?
  totalAmount      Decimal             @db.Decimal(12, 2)
  taxAmount        Decimal             @db.Decimal(12, 2)
  grandTotal       Decimal             @db.Decimal(12, 2)
  paidAmount       Decimal             @default(0) @db.Decimal(12, 2)
  status           PurchaseOrderStatus @default(PENDING)
  invoiceNumber    String?
  invoiceDate      DateTime?
  notes            String?             @db.Text
  createdBy        String
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  supplier           Supplier             @relation(fields: [supplierId], references: [id])
  branch             Branch               @relation(fields: [branchId], references: [id])
  company            Company              @relation(fields: [companyId], references: [id])
  createdByUser      User                 @relation("UserCreatedPurchaseOrders", fields: [createdBy], references: [id])
  items              PurchaseOrderItem[]
  payments           SupplierPayment[]
  replacementReturns PurchaseItemReturn[] @relation("ReplacementPO")

  @@index([supplierId, branchId, companyId])
  @@index([status])
  @@index([poNumber])
  @@index([createdBy])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String   @id @default(uuid())
  purchaseOrderId String
  inventoryId     String? // Old inventory reference (deprecated, keep for migration)
  itemId          String? // New item reference
  quantity        Decimal  @db.Decimal(10, 2)
  unitPrice       Decimal  @db.Decimal(10, 2)
  salesPrice      Decimal? @db.Decimal(10, 2)
  taxRate         Decimal  @db.Decimal(5, 2)
  taxAmount       Decimal  @db.Decimal(10, 2)
  totalAmount     Decimal  @db.Decimal(10, 2)
  receivedQty     Decimal  @default(0) @db.Decimal(10, 2)
  returnedQty     Decimal  @default(0) @db.Decimal(10, 2)
  createdAt       DateTime @default(now())

  purchaseOrder PurchaseOrder        @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  inventory     Inventory?           @relation(fields: [inventoryId], references: [id])
  item          Item?                @relation(fields: [itemId], references: [id])
  returns       PurchaseItemReturn[]

  @@index([purchaseOrderId])
  @@index([inventoryId])
  @@index([itemId])
  @@map("purchase_order_items")
}

model SupplierPayment {
  id              String   @id @default(uuid())
  purchaseOrderId String
  supplierId      String
  amount          Decimal  @db.Decimal(12, 2)
  paymentDate     DateTime @default(now())
  paymentMethodId String?
  referenceNumber String?
  notes           String?  @db.Text
  branchId        String
  companyId       String
  createdBy       String
  createdAt       DateTime @default(now())

  purchaseOrder PurchaseOrder  @relation(fields: [purchaseOrderId], references: [id])
  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  paymentMethod PaymentMethod? @relation("PaymentMethodSupplierPayments", fields: [paymentMethodId], references: [id])
  branch        Branch         @relation(fields: [branchId], references: [id])
  company       Company        @relation(fields: [companyId], references: [id])
  createdByUser User           @relation("UserCreatedPayments", fields: [createdBy], references: [id])

  @@index([purchaseOrderId])
  @@index([supplierId, branchId])
  @@index([paymentMethodId])
  @@index([createdBy])
  @@map("supplier_payments")
}

model PurchaseItemReturn {
  id                  String               @id @default(uuid())
  purchaseOrderItemId String
  returnQty           Decimal              @db.Decimal(10, 2)
  returnReason        PurchaseReturnReason
  returnType          PurchaseReturnType   @default(REFUND)
  returnStatus        PurchaseReturnStatus @default(PENDING)
  refundAmount        Decimal              @db.Decimal(12, 2)
  replacementPOId     String?
  stockDeducted       Boolean              @default(false)
  refundProcessed     Boolean              @default(false)
  notes               String?              @db.Text
  returnDate          DateTime             @default(now())
  branchId            String
  companyId           String
  createdBy           String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  purchaseOrderItem  PurchaseOrderItem   @relation(fields: [purchaseOrderItemId], references: [id], onDelete: Cascade)
  replacementPO      PurchaseOrder?      @relation("ReplacementPO", fields: [replacementPOId], references: [id])
  branch             Branch              @relation(fields: [branchId], references: [id])
  company            Company             @relation(fields: [companyId], references: [id])
  createdByUser      User                @relation("UserCreatedPurchaseReturns", fields: [createdBy], references: [id])
  refundTransactions RefundTransaction[]

  @@index([purchaseOrderItemId])
  @@index([branchId, companyId])
  @@index([createdBy])
  @@index([returnStatus])
  @@index([replacementPOId])
  @@map("purchase_item_returns")
}

model RefundTransaction {
  id               String   @id @default(uuid())
  purchaseReturnId String
  refundAmount     Decimal  @db.Decimal(12, 2)
  refundDate       DateTime @default(now())
  paymentMethodId  String?
  referenceNumber  String?
  notes            String?  @db.Text
  processedBy      String
  branchId         String
  companyId        String
  createdAt        DateTime @default(now())

  purchaseReturn  PurchaseItemReturn @relation(fields: [purchaseReturnId], references: [id], onDelete: Cascade)
  paymentMethod   PaymentMethod?     @relation("RefundPaymentMethod", fields: [paymentMethodId], references: [id])
  branch          Branch             @relation(fields: [branchId], references: [id])
  company         Company            @relation(fields: [companyId], references: [id])
  processedByUser User               @relation("UserProcessedRefunds", fields: [processedBy], references: [id])

  @@index([purchaseReturnId])
  @@index([branchId, companyId])
  @@index([processedBy])
  @@index([refundDate])
  @@map("refund_transactions")
}

// ==================== EXPENSE MANAGEMENT MODELS ====================

model ExpenseCategory {
  id          String    @id @default(uuid())
  name        String
  code        String?
  description String?
  isActive    Boolean   @default(true)
  companyId   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  expenses    Expense[]

  @@unique([name, companyId])
  @@index([companyId])
  @@index([isActive])
  @@map("expense_categories")
}

model PettyCashTransfer {
  id              String                  @id @default(uuid())
  transferNumber  String                  @unique
  branchId        String
  employeeId      String?
  amount          Decimal                 @db.Decimal(12, 2)
  transferDate    DateTime                @default(now())
  paymentMethodId String?
  transactionRef  String?
  bankDetails     String?
  purpose         String?                 @db.Text
  remarks         String?                 @db.Text
  proofUrl        String?
  status          PettyCashTransferStatus @default(COMPLETED)
  companyId       String
  createdBy       String
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  branch        Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
  employee      User?          @relation("EmployeeReceivedPettyCashTransfers", fields: [employeeId], references: [id])
  paymentMethod PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdByUser User           @relation("UserCreatedPettyCashTransfers", fields: [createdBy], references: [id])

  @@index([branchId, companyId])
  @@index([transferNumber])
  @@index([status])
  @@index([createdBy])
  @@index([employeeId])
  @@map("petty_cash_transfers")
}

model PettyCashRequest {
  id              String                 @id @default(uuid())
  requestNumber   String                 @unique
  branchId        String
  requestedAmount Decimal                @db.Decimal(12, 2)
  reason          String                 @db.Text
  status          PettyCashRequestStatus @default(PENDING)
  requestedBy     String
  approvedBy      String?
  approvedAt      DateTime?
  rejectedReason  String?                @db.Text
  companyId       String
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  branch          Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  requestedByUser User    @relation("UserRequestedPettyCash", fields: [requestedBy], references: [id])
  approvedByUser  User?   @relation("UserApprovedPettyCash", fields: [approvedBy], references: [id])
  company         Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([branchId, companyId])
  @@index([requestNumber])
  @@index([status])
  @@index([requestedBy])
  @@index([approvedBy])
  @@map("petty_cash_requests")
}

model Expense {
  id            String   @id @default(uuid())
  expenseNumber String   @unique
  branchId      String
  categoryId    String
  amount        Decimal  @db.Decimal(12, 2)
  expenseDate   DateTime @default(now())
  description   String   @db.Text
  billNumber    String?
  vendorName    String?
  attachmentUrl String?
  remarks       String?  @db.Text
  recordedBy    String
  companyId     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  branch         Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  category       ExpenseCategory @relation(fields: [categoryId], references: [id])
  recordedByUser User            @relation("UserRecordedExpenses", fields: [recordedBy], references: [id])
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  paymentEntries PaymentEntry[]  @relation("ExpensePaymentEntries")

  @@index([branchId, companyId])
  @@index([expenseNumber])
  @@index([categoryId])
  @@index([expenseDate])
  @@index([recordedBy])
  @@map("expenses")
}

// ==========================================
// ANALYTICS & REPORTING MODELS
// ==========================================

model TechnicianPerformanceLog {
  id                String   @id @default(uuid())
  technicianId      String
  date              DateTime @db.Date
  servicesCompleted Int      @default(0)
  totalRevenue      Decimal  @default(0) @db.Decimal(12, 2)
  avgCompletionTime Float? // in hours
  customerRating    Float? // average rating for the day
  activeHours       Float? // hours logged as active
  idleHours         Float? // hours logged as idle
  companyId         String
  branchId          String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  technician User    @relation("TechnicianPerformance", fields: [technicianId], references: [id], onDelete: Cascade)
  company    Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch     Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([technicianId, date])
  @@index([technicianId, date])
  @@index([branchId, date])
  @@index([companyId, date])
  @@map("technician_performance_logs")
}

model ServiceRating {
  id        String   @id @default(uuid())
  serviceId String   @unique
  rating    Int // 1-5 stars
  feedback  String?  @db.Text
  ratedAt   DateTime @default(now())

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([rating])
  @@index([ratedAt])
  @@map("service_ratings")
}

model ReportCache {
  id          String   @id @default(uuid())
  reportType  String // e.g., "technician_performance", "revenue_report"
  reportKey   String   @unique // hash of parameters
  companyId   String
  branchId    String?
  data        Json // cached report data
  generatedAt DateTime @default(now())
  expiresAt   DateTime

  @@index([reportKey])
  @@index([reportType, companyId])
  @@index([expiresAt])
  @@map("report_caches")
}

// ==========================================
// TECHNICIAN MANAGEMENT SYSTEM
// ==========================================

enum PointsType {
  SERVICE_COMPLETED
  SERVICE_DELIVERED
  RATING_BONUS
  SPEED_BONUS
  DAILY_TARGET_BONUS
  WEEKLY_TARGET_BONUS
  PENALTY_LATE
  PENALTY_REWORK
  MANUAL_ADJUSTMENT
  PROMOTION_BONUS
}

enum NotificationType {
  SERVICE_ASSIGNED
  SERVICE_REASSIGNED
  POINTS_EARNED
  LEVEL_PROMOTION
  DAILY_TARGET
  REMINDER
  ANNOUNCEMENT
}

model TechnicianLevel {
  id               String   @id @default(uuid())
  name             String // "Junior Technician", "Senior Technician", etc.
  code             String // "JUNIOR", "SENIOR", "EXPERT"
  minPoints        Int // Minimum points required
  maxPoints        Int? // Maximum points (null for highest level)
  pointsMultiplier Float    @default(1.0) // Bonus multiplier for points
  incentivePercent Float    @default(0) // Percentage incentive on service revenue
  badgeColor       String? // "#FFD700" for gold, etc.
  description      String?
  sortOrder        Int      @default(0)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  technicians       TechnicianProfile[]
  promotionToThis   TechnicianPromotion[] @relation("PromotedToLevel")
  promotionFromThis TechnicianPromotion[] @relation("PromotedFromLevel")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
  @@index([companyId])
  @@index([sortOrder])
  @@map("technician_levels")
}

model TechnicianProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Points & Level
  totalPoints    Int              @default(0)
  currentLevelId String?
  currentLevel   TechnicianLevel? @relation(fields: [currentLevelId], references: [id])
  levelPromotedAt DateTime?

  // Performance Metrics (cached for quick display)
  totalServicesCompleted Int     @default(0)
  totalRevenue           Decimal @default(0) @db.Decimal(12, 2)
  averageRating          Float?
  avgCompletionHours     Float?

  // Availability
  isAvailable       Boolean @default(true)
  maxConcurrentJobs Int     @default(5)

  companyId String
  branchId  String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch    Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // Relations
  skills        TechnicianSkill[]
  pointsHistory TechnicianPointsHistory[]
  promotions    TechnicianPromotion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, branchId])
  @@index([currentLevelId])
  @@index([totalPoints])
  @@map("technician_profiles")
}

model TechnicianSkill {
  id                  String            @id @default(uuid())
  technicianProfileId String
  technicianProfile   TechnicianProfile @relation(fields: [technicianProfileId], references: [id], onDelete: Cascade)

  faultId String
  fault   Fault @relation(fields: [faultId], references: [id], onDelete: Cascade)

  proficiencyLevel Int      @default(1) // 1-5 skill level
  isVerified       Boolean  @default(false)
  verifiedAt       DateTime?
  verifiedBy       String? // User ID who verified

  createdAt DateTime @default(now())

  @@unique([technicianProfileId, faultId])
  @@index([faultId])
  @@map("technician_skills")
}

model TechnicianPointsHistory {
  id                  String            @id @default(uuid())
  technicianProfileId String
  technicianProfile   TechnicianProfile @relation(fields: [technicianProfileId], references: [id], onDelete: Cascade)

  points      Int // Can be positive or negative
  type        PointsType
  description String

  // Reference to source
  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  // Bonus info
  bonusMultiplier Float @default(1.0)
  basePoints      Int // Points before multiplier

  createdAt DateTime @default(now())

  @@index([technicianProfileId])
  @@index([serviceId])
  @@index([createdAt])
  @@index([type])
  @@map("technician_points_history")
}

model TechnicianPromotion {
  id                  String            @id @default(uuid())
  technicianProfileId String
  technicianProfile   TechnicianProfile @relation(fields: [technicianProfileId], references: [id], onDelete: Cascade)

  fromLevelId String?
  fromLevel   TechnicianLevel? @relation("PromotedFromLevel", fields: [fromLevelId], references: [id])

  toLevelId String
  toLevel   TechnicianLevel @relation("PromotedToLevel", fields: [toLevelId], references: [id])

  pointsAtPromotion Int
  promotedBy        String // User ID who approved
  notes             String?

  createdAt DateTime @default(now())

  @@index([technicianProfileId])
  @@index([toLevelId])
  @@map("technician_promotions")
}

model TechnicianNotification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String
  data    Json? // Additional data (serviceId, points, etc.)

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("technician_notifications")
}

// ============================================
// Document Number Format Models
// ============================================

enum DocumentType {
  JOB_SHEET
  SERVICE_TICKET
  INVOICE
  ESTIMATE
}

enum SequenceResetFrequency {
  NEVER
  DAILY
  MONTHLY
  YEARLY
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model DocumentNumberFormat {
  id                     String                  @id @default(uuid())
  documentType           DocumentType
  prefix                 String                  @default("JS")
  separator              String                  @default("-")
  sequenceResetFrequency SequenceResetFrequency  @default(DAILY)
  sequenceLength         Int                     @default(3)
  includeBranch          Boolean                 @default(true)
  branchFormat           String                  @default("CODE") // CODE or NUMBER
  includeYear            Boolean                 @default(true)
  yearFormat             String                  @default("FULL") // FULL (2025) or SHORT (25)
  includeMonth           Boolean                 @default(false)
  includeDay             Boolean                 @default(false)
  companyId              String
  company                Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sequences              DocumentSequence[]
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt

  @@unique([companyId, documentType])
  @@index([companyId])
  @@map("document_number_formats")
}

model DocumentSequence {
  id              String               @id @default(uuid())
  formatId        String
  format          DocumentNumberFormat @relation(fields: [formatId], references: [id], onDelete: Cascade)
  branchId        String?
  branch          Branch?              @relation(fields: [branchId], references: [id], onDelete: Cascade)
  periodKey       String?              // "2025" for yearly, "2025-12" for monthly, "2025-12-15" for daily, null for never
  currentSequence Int                  @default(0)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@unique([formatId, branchId, periodKey])
  @@index([formatId])
  @@index([branchId])
  @@map("document_sequences")
}

// ============================================
// Daily Opening Balance for Cash Settlement
// ============================================

model DailyOpeningBalance {
  id              String        @id @default(uuid())
  date            DateTime      @db.Date
  paymentMethodId String
  paymentMethod   PaymentMethod @relation("PaymentMethodOpeningBalances", fields: [paymentMethodId], references: [id], onDelete: Cascade)
  openingAmount   Decimal       @default(0) @db.Decimal(15, 2)
  closingAmount   Decimal       @default(0) @db.Decimal(15, 2)
  branchId        String
  branch          Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  companyId       String
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([date, paymentMethodId, branchId])
  @@index([date])
  @@index([paymentMethodId])
  @@index([branchId])
  @@index([companyId])
  @@map("daily_opening_balances")
}

// ============================================
// Task Management
// ============================================

model Task {
  id           String       @id @default(uuid())
  taskNumber   String       @unique
  title        String
  description  String?      @db.Text
  status       TaskStatus   @default(PENDING)
  priority     TaskPriority @default(MEDIUM)

  // Assignment
  assignedToId String
  assignedTo   User         @relation("TaskAssignee", fields: [assignedToId], references: [id])

  // Creator
  createdById  String
  createdBy    User         @relation("TaskCreator", fields: [createdById], references: [id])

  // Multi-tenancy
  companyId    String
  company      Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branchId     String
  branch       Branch       @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // Dates
  dueDate      DateTime
  completedAt  DateTime?

  // Bulk tracking (tasks created together share same batchId)
  batchId      String?

  // Notes
  notes        String?      @db.Text

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([companyId])
  @@index([branchId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([status])
  @@index([dueDate])
  @@index([batchId])
  @@map("tasks")
}

// ============================================
// Cash Settlement Management
// ============================================

model CashSettlement {
  id                    String                @id @default(uuid())
  settlementNumber      String                @unique
  settlementDate        DateTime              @db.Date
  branchId              String
  branch                Branch                @relation(fields: [branchId], references: [id], onDelete: Cascade)
  companyId             String
  company               Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)

  status                CashSettlementStatus  @default(PENDING)

  settledById           String
  settledBy             User                  @relation("SettlementSettledBy", fields: [settledById], references: [id])
  settledAt             DateTime?

  verifiedById          String?
  verifiedBy            User?                 @relation("SettlementVerifiedBy", fields: [verifiedById], references: [id])
  verifiedAt            DateTime?
  verificationNotes     String?               @db.Text

  rejectedById          String?
  rejectedBy            User?                 @relation("SettlementRejectedBy", fields: [rejectedById], references: [id])
  rejectedAt            DateTime?
  rejectionReason       String?               @db.Text

  totalCollected        Decimal               @default(0) @db.Decimal(15, 2)
  totalRefunds          Decimal               @default(0) @db.Decimal(15, 2)
  totalExpenses         Decimal               @default(0) @db.Decimal(15, 2)
  netCashAmount         Decimal               @default(0) @db.Decimal(15, 2)
  physicalCashCount     Decimal               @default(0) @db.Decimal(15, 2)
  cashDifference        Decimal               @default(0) @db.Decimal(15, 2)

  notes                 String?               @db.Text

  methodBreakdowns      CashSettlementMethod[]
  denominations         CashDenomination?

  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  @@unique([settlementDate, branchId])
  @@index([branchId])
  @@index([companyId])
  @@index([settlementDate])
  @@index([status])
  @@index([settledById])
  @@index([verifiedById])
  @@map("cash_settlements")
}

model CashSettlementMethod {
  id                    String          @id @default(uuid())
  cashSettlementId      String
  cashSettlement        CashSettlement  @relation(fields: [cashSettlementId], references: [id], onDelete: Cascade)
  paymentMethodId       String
  paymentMethod         PaymentMethod   @relation("SettlementMethods", fields: [paymentMethodId], references: [id])

  openingBalance        Decimal         @default(0) @db.Decimal(15, 2)
  collectedAmount       Decimal         @default(0) @db.Decimal(15, 2)
  refundedAmount        Decimal         @default(0) @db.Decimal(15, 2)
  expenseAmount         Decimal         @default(0) @db.Decimal(15, 2)
  closingBalance        Decimal         @default(0) @db.Decimal(15, 2)
  transactionCount      Int             @default(0)

  createdAt             DateTime        @default(now())

  @@unique([cashSettlementId, paymentMethodId])
  @@index([cashSettlementId])
  @@index([paymentMethodId])
  @@map("cash_settlement_methods")
}

model CashDenomination {
  id                    String          @id @default(uuid())
  cashSettlementId      String          @unique
  cashSettlement        CashSettlement  @relation(fields: [cashSettlementId], references: [id], onDelete: Cascade)

  note2000Count         Int             @default(0)
  note500Count          Int             @default(0)
  note200Count          Int             @default(0)
  note100Count          Int             @default(0)
  note50Count           Int             @default(0)
  note20Count           Int             @default(0)
  note10Count           Int             @default(0)
  coin5Count            Int             @default(0)
  coin2Count            Int             @default(0)
  coin1Count            Int             @default(0)
  totalAmount           Decimal         @default(0) @db.Decimal(15, 2)

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([cashSettlementId])
  @@map("cash_denominations")
}

// ============================================
// Warranty Management
// ============================================

model WarrantyRecord {
  id                String      @id @default(uuid())
  warrantyNumber    String      @unique  // WRT-1-20251223-001

  // Source - either service part OR invoice item
  sourceType        String      // "SERVICE" or "SALE"
  serviceId         String?     // If from service
  servicePartId     String?     @unique // Specific part in service (one warranty per part)
  invoiceId         String?     // If from direct sale
  invoiceItemId     String?     // Specific item in invoice

  // Item & Customer
  itemId            String
  customerId        String

  // Warranty Period
  warrantyDays      Int
  startDate         DateTime    // Delivery date (service) or Invoice date (sale)
  endDate           DateTime    // Calculated: startDate + warrantyDays

  // Claim tracking
  isClaimed         Boolean     @default(false)
  claimedAt         DateTime?
  claimServiceId    String?     // Service created for warranty claim
  claimReason       String?

  // Multi-tenancy
  companyId         String
  branchId          String

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  item              Item        @relation(fields: [itemId], references: [id])
  customer          Customer    @relation(fields: [customerId], references: [id])
  service           Service?    @relation("ServiceWarrantyRecords", fields: [serviceId], references: [id], onDelete: SetNull)
  servicePart       ServicePart? @relation(fields: [servicePartId], references: [id], onDelete: SetNull)
  invoice           Invoice?    @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  claimService      Service?    @relation("WarrantyClaimService", fields: [claimServiceId], references: [id], onDelete: SetNull)
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch            Branch      @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([itemId])
  @@index([serviceId])
  @@index([invoiceId])
  @@index([endDate])
  @@index([companyId])
  @@index([branchId])
  @@index([isClaimed])
  @@map("warranty_records")
}

// ============================================
// Sales Return Models
// ============================================

model SalesReturn {
  id                String             @id @default(uuid())
  returnNumber      String             @unique
  invoiceId         String
  customerId        String

  returnStatus      SalesReturnStatus  @default(PENDING)
  returnReason      SalesReturnReason
  totalReturnAmount Decimal            @db.Decimal(12, 2)
  refundedAmount    Decimal            @default(0) @db.Decimal(12, 2)
  refundProcessed   Boolean            @default(false)

  paymentMethodId   String?
  referenceNumber   String?
  notes             String?            @db.Text
  returnDate        DateTime           @default(now())

  branchId          String
  companyId         String
  createdById       String
  processedById     String?
  processedAt       DateTime?

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  invoice           Invoice            @relation(fields: [invoiceId], references: [id])
  customer          Customer           @relation("SalesReturnCustomer", fields: [customerId], references: [id])
  paymentMethod     PaymentMethod?     @relation("SalesReturnRefunds", fields: [paymentMethodId], references: [id])
  branch            Branch             @relation(fields: [branchId], references: [id])
  company           Company            @relation(fields: [companyId], references: [id])
  createdBy         User               @relation("UserCreatedSalesReturns", fields: [createdById], references: [id])
  processedBy       User?              @relation("UserProcessedSalesReturns", fields: [processedById], references: [id])

  items             SalesReturnItem[]

  @@index([invoiceId])
  @@index([customerId])
  @@index([branchId, companyId])
  @@index([returnStatus])
  @@index([returnNumber])
  @@map("sales_returns")
}

model SalesReturnItem {
  id              String       @id @default(uuid())
  salesReturnId   String
  invoiceItemId   String

  returnQuantity  Float
  unitPrice       Float
  returnAmount    Float
  reason          String?

  createdAt       DateTime     @default(now())

  // Relations
  salesReturn     SalesReturn  @relation(fields: [salesReturnId], references: [id], onDelete: Cascade)
  invoiceItem     InvoiceItem  @relation(fields: [invoiceItemId], references: [id])

  @@unique([salesReturnId, invoiceItemId])
  @@index([salesReturnId])
  @@index([invoiceItemId])
  @@map("sales_return_items")
}
